<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Total Noise Injector</title>
    <style>
        body { font-family: 'Courier New', Courier, monospace; display: flex; flex-direction: column; align-items: center; background: #050505; color: #00ff41; margin: 0; padding: 20px; }
        .card { background: #111; padding: 25px; border-radius: 5px; width: 100%; max-width: 450px; text-align: center; border: 1px solid #00ff41; box-shadow: 0 0 20px rgba(0,255,65,0.2); }
        #previewContainer { position: relative; margin-top: 20px; display: none; width: 100%; border: 1px solid #333; overflow: hidden; }
        #displayImg { width: 100%; display: block; filter: contrast(1.05); }
        #scanLine { position: absolute; top: 0; left: 0; width: 100%; height: 1px; background: #00ff41; box-shadow: 0 0 10px #00ff41; display: none; }
        #status { margin: 15px 0; font-size: 0.8rem; text-transform: uppercase; letter-spacing: 2px; }
        .instruction { font-size: 0.75rem; color: #888; margin-top: 15px; }
        input[type="file"] { margin: 20px 0; color: #00ff41; }
    </style>
</head>
<body>

<div class="card">
    <h3>DATA ENTROPY INJECTOR</h3>
    <p style="font-size: 0.7rem; color: #008f11;">FULL-SPECTRUM LATENT NOISE</p>
    
    <input type="file" id="upload" accept="image/png">
    
    <div id="status">System Ready</div>

    <div id="previewContainer">
        <canvas id="canvas" style="display:none;"></canvas>
        <img id="displayImg">
        <div id="scanLine"></div>
    </div>
    
    <p id="saveHint" class="instruction" style="display:none;">
        [SEQUENCE COMPLETE]<br>
        画像を<b>長押し</b>して「保存」してください。<br>
        この画像はAI再構築のための「種」となります。
    </p>
</div>

<script>
    const upload = document.getElementById('upload');
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const displayImg = document.getElementById('displayImg');
    const previewContainer = document.getElementById('previewContainer');
    const scanLine = document.getElementById('scanLine');
    const status = document.getElementById('status');
    const saveHint = document.getElementById('saveHint');

    upload.addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if (!file) return;

        const img = new Image();
        img.src = URL.createObjectURL(file);

        img.onload = () => {
            canvas.width = img.width;
            canvas.height = img.height;
            ctx.drawImage(img, 0, 0);

            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;

            previewContainer.style.display = 'block';
            displayImg.src = img.src;
            scanLine.style.display = 'block';
            saveHint.style.display = 'none';

            const duration = 3000; 
            const start = performance.now();

            function injectAll() {
                for (let i = 0; i < data.length; i += 4) {
                    const x = (i / 4) % canvas.width;
                    const y = Math.floor((i / 4) / canvas.width);

                    // 1. 高周波 (Pixel-level White Noise)
                    const hf = (Math.random() - 0.5) * 0.5;

                    // 2. 中周波 (Mid-range Turbulence)
                    const mf = Math.sin(x * 0.1) * Math.cos(y * 0.1) * 0.3;

                    // 3. 低周波 (Global Drift)
                    const lf = Math.sin(x * 0.01 + y * 0.01) * 0.2;

                    // 4. 色相/彩度への揺らぎ (Chromatic Aberration Noise)
                    const colorNoiseR = (Math.random() - 0.5) * 0.2;
                    const colorNoiseG = (Math.random() - 0.5) * 0.2;
                    const colorNoiseB = (Math.random() - 0.5) * 0.2;

                    // すべてを統合
                    data[i]     = Math.min(255, Math.max(0, data[i] + hf + mf + lf + colorNoiseR));     // R
                    data[i + 1] = Math.min(255, Math.max(0, data[i + 1] + hf + mf + lf + colorNoiseG)); // G
                    data[i + 2] = Math.min(255, Math.max(0, data[i + 2] + hf + mf + lf + colorNoiseB)); // B
                    
                    // 5. 不可視のアルファノイズ (メタデータ/透過レイヤーへの干渉)
                    if (data[i+3] > 250) {
                        data[i+3] = 255 - Math.floor(Math.random() * 2); 
                    }
                }
            }

            function animate(now) {
                const elapsed = now - start;
                const progress = Math.min(elapsed / duration, 1);
                scanLine.style.top = (progress * 100) + '%';
                status.innerText = `Injecting Entropy: ${Math.floor(progress * 100)}%`;

                if (progress < 1) {
                    requestAnimationFrame(animate);
                } else {
                    injectAll();
                    ctx.putImageData(imageData, 0, 0);
                    displayImg.src = canvas.toDataURL('image/png');
                    status.innerText = "ENTROPY MAXIMIZED";
                    scanLine.style.display = 'none';
                    saveHint.style.display = 'block';
                }
            }
            requestAnimationFrame(animate);
        };
    });
</script>

</body>
</html>
